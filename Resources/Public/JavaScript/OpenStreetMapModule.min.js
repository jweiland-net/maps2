import{ExtConf,PoiCollection}from"@jweiland/maps2/Classes.js";import FormEngine from"@typo3/backend/form-engine.js";class OpenStreetMapModule{"use strict";element={};map={};constructor(){this.element=document.querySelector("#maps2ConfigurationMap");let e=new ExtConf(JSON.parse(this.element.dataset.extConf)),t=new PoiCollection(JSON.parse(this.element.dataset.poiCollection)),a={};switch(this.createMap(),t.collectionType){case"Point":a=this.createMarker(t);break;case"Area":this.createArea(t,e);break;case"Route":this.createRoute(t,e);break;case"Radius":a=this.createRadius(t,e)}this.findAddress(t,a),t.latitude&&t.longitude?this.map.panTo([t.latitude,t.longitude]):this.map.panTo([e.defaultLatitude,e.defaultLongitude]),document.querySelector("ul.t3js-tabs li:nth-of-type(2) a[data-bs-toggle='tab']").addEventListener("shown.bs.tab",()=>{this.map.invalidateSize(),t.latitude&&t.longitude?this.map.panTo([t.latitude,t.longitude]):this.map.panTo([e.defaultLatitude,e.defaultLongitude])})}createMap=()=>{this.map=L.map(this.element,{editable:!0}).setView([51.505,-.09],15),L.tileLayer(location.protocol+"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18,attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',id:"mapbox.streets"}).addTo(this.map)};createMarker=t=>{let a=this,o=L.marker([t.latitude,t.longitude],{draggable:!0}).addTo(this.map);return o.on("dragend",()=>{a.setLatLngFields(t,o.getLatLng().lat.toFixed(6),o.getLatLng().lng.toFixed(6),0)}),this.map.on("click",e=>{o.setLatLng(e.latlng),a.setLatLngFields(t,e.latlng.lat.toFixed(6),e.latlng.lng.toFixed(6),0)}),o};createArea=(t,e)=>{let a=this,o={};var i=[],e={color:e.strokeColor,weight:e.strokeWeight,opacity:e.strokeOpacity,fillColor:e.fillColor,fillOpacity:e.fillOpacity};if(t.configurationMap)for(let e=0;e<t.configurationMap.length;e++)i.push([t.configurationMap[e].latitude,t.configurationMap[e].longitude]);0===i.length?o=this.map.editTools.startPolygon(null,e):(o=L.polygon(i,e).addTo(this.map)).enableEdit(),this.map.on("moveend",e=>{a.setLatLngFields(t,e.target.getCenter().lat.toFixed(6),e.target.getCenter().lng.toFixed(6),0)}),this.map.on("editable:vertex:new",e=>{a.storeRouteAsJson(t,o.getLatLngs()[0])}),this.map.on("editable:vertex:deleted",e=>{a.storeRouteAsJson(t,o.getLatLngs()[0])}),this.map.on("editable:vertex:dragend",e=>{a.storeRouteAsJson(t,o.getLatLngs()[0])})};createRoute=(t,e)=>{let a=this,o={};var i=[],e={color:e.strokeColor,weight:e.strokeWeight,opacity:e.strokeOpacity};if(t.configurationMap)for(let e=0;e<t.configurationMap.length;e++)i.push([t.configurationMap[e].latitude,t.configurationMap[e].longitude]);0===i.length?o=this.map.editTools.startPolyline(null,e):(o=L.polyline(i,e).addTo(this.map)).enableEdit(),this.map.on("moveend",e=>{a.setLatLngFields(t,e.target.getCenter().lat.toFixed(6),e.target.getCenter().lng.toFixed(6),0)}),this.map.on("editable:vertex:new",e=>{a.storeRouteAsJson(t,o.getLatLngs())}),this.map.on("editable:vertex:deleted",e=>{a.storeRouteAsJson(t,o.getLatLngs())}),this.map.on("editable:vertex:dragend",e=>{a.storeRouteAsJson(t,o.getLatLngs())})};createRadius=(t,e)=>{let a=this,o=L.circle([t.latitude,t.longitude],{color:e.strokeColor,opacity:e.strokeOpacity,weight:e.strokeWeight,fillColor:e.fillColor,fillOpacity:e.fillOpacity,radius:t.radius||e.defaultRadius}).addTo(this.map);o.enableEdit();return o.on("editable:dragend editable:vertex:dragend",e=>{a.setLatLngFields(t,o.getLatLng().lat.toFixed(6),o.getLatLng().lng.toFixed(6),o.getRadius())}),o};setLatLngFields=(e,t,a,o,i)=>{this.setFieldValue(e,"latitude",t),this.setFieldValue(e,"longitude",a),void 0!==o&&0<o&&this.setFieldValue(e,"radius",parseInt(o)),void 0!==i&&this.setFieldValue(e,"address",i)};getUriForCoordinates=t=>{var a={};for(let e=0;e<t.length;e++)a[e]=t[e].lat+","+t[e].lng;return a};getFieldElement=(e,t)=>FormEngine.getFieldElement(this.buildFieldName(e,t),"_list");buildFieldName=(e,t)=>"data[tx_maps2_domain_model_poicollection]["+e.uid+"]["+t+"]";setFieldValue=(e,t,a)=>{e=this.getFieldElement(e,t);e&&e.length&&(e.val(a),e.triggerHandler("change"))};storeRouteAsJson=(e,t)=>{this.setFieldValue(e,"configuration_map",JSON.stringify(this.getUriForCoordinates(t)))};findAddress=(i,s)=>{let n=this;document.querySelector("#pac-search").addEventListener("keydown",e=>{if(13===e.keyCode&&e.target.value)return e.preventDefault(),fetch("https://nominatim.openstreetmap.org/search?q="+encodeURI(e.target.value)+"&format=json&addressdetails=1",{method:"GET",headers:{"Content-Type":"application/json"}}).then(e=>e.json()).then(e=>{if(0===e.length)alert("Address not found");else{var t=parseFloat(e[0].lat).toFixed(6),a=parseFloat(e[0].lon).toFixed(6),e=e[0].address,o=n.getFormattedAddress(e);switch(i.collectionType){case"Point":s.setLatLng([t,a]),n.setLatLngFields(i,t,a,0,o);break;case"Area":case"Route":n.setLatLngFields(i,t,a,0,o);break;case"Radius":s.setLatLng([t,a]),s.editor.updateResizeLatLng(),s.editor.reset(),n.setLatLngFields(i,t,a,s.getRadius(),o)}n.map.panTo([t,a])}}).catch(e=>console.error("Error:",e)),!1})};getFormattedAddress=e=>{let t="",a="";return e.hasOwnProperty("road")&&(t+=e.road),e.hasOwnProperty("houseNumber")&&(t+=" "+e.houseNumber),e.hasOwnProperty("postcode")&&(t+=", "+e.postcode),e.hasOwnProperty("village")&&(a=e.village),e.hasOwnProperty("town")&&(a=e.town),e.hasOwnProperty("city")&&(a=e.city),t+=" "+a,e.hasOwnProperty("country")&&(t+=", "+e.country),t}}export default new OpenStreetMapModule;
//# sourceMappingURL=OpenStreetMapModule.min.js.map
