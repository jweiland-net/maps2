import{ExtConf,PoiCollection}from"@jweiland/maps2/Classes.js";import FormEngine from"@typo3/backend/form-engine.js";import Notification from"@typo3/backend/notification.js";class GoogleMapsModule{selector="#maps2ConfigurationMap";record=[];extConf=[];marker={};map={};infoWindow={};infoWindowContent={};constructor(){let e=document.querySelector(this.selector),t=new PoiCollection(JSON.parse(e.dataset.poiCollection)),o=new ExtConf(JSON.parse(e.dataset.extConf));this.load(o).then(()=>{this.initialize(e,t,o)})}load=t=>{return window._GoogleMapsModule=this,window._GoogleMapsModule.initMaps=this.initMaps.bind(this),new Promise(e=>{this.resolve=e;e=document.createElement("script");e.src=t.googleMapsLibrary+"&callback=_GoogleMapsModule.initMaps",e.async=!0,document.body.append(e)})};initMaps=()=>{this.resolve&&this.resolve()};initialize=(e,t,o)=>{switch(this.record=t,this.extConf=o,this.infoWindow=new google.maps.InfoWindow,this.infoWindowContent=document.getElementById("infowindow-content"),this.map=this.createMap(e),""===o.googleMapsJavaScriptApiKey&&Notification.warning("Missing JS API Key","You have forgotten to set Google Maps JavaScript ApiKey in Extension Settings.",15),""===o.googleMapsGeocodeApiKey&&Notification.warning("Missing GeoCode API Key","You have forgotten to set Google Maps Geocode ApiKey in Extension Settings.",15),t.collectionType){case"Point":this.createMarker(t);break;case"Area":this.createArea(t);break;case"Route":this.createRoute(t);break;case"Radius":this.createRadius(t)}this.findAddress(),t.latitude&&t.longitude?this.map.setCenter(new google.maps.LatLng(t.latitude,t.longitude)):this.map.setCenter(new google.maps.LatLng(o.defaultLatitude,o.defaultLongitude)),document.querySelector("ul.t3js-tabs li:nth-of-type(2) button[data-bs-toggle='tab']").addEventListener("shown.bs.tab",()=>{google.maps.event.trigger(this.map,"resize"),t.latitude&&t.longitude?this.map.setCenter(new google.maps.LatLng(t.latitude,t.longitude)):this.map.setCenter(new google.maps.LatLng(o.defaultLatitude,o.defaultLongitude))})};createMapOptions=()=>({zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP});createCircleOptions=(e,t,o)=>{e={map:e,center:new google.maps.LatLng(t.latitude,t.longitude),strokeColor:o.strokeColor,strokeOpacity:o.strokeOpacity,strokeWeight:o.strokeWeight,fillColor:o.fillColor,fillOpacity:o.fillOpacity,editable:!0};return 0===t.radius?e.radius=o.defaultRadius:e.radius=t.radius,e};createPolygonOptions=(e,t)=>({paths:e,strokeColor:t.strokeColor,strokeOpacity:t.strokeOpacity,strokeWeight:t.strokeWeight,fillColor:t.fillColor,fillOpacity:t.fillOpacity,editable:!0});createPolylineOptions=(e,t)=>({path:e,strokeColor:t.strokeColor,strokeOpacity:t.strokeOpacity,strokeWeight:t.strokeWeight,editable:!0});createMap=e=>new google.maps.Map(e,this.createMapOptions());createMarker=e=>{let t=new google.maps.Marker({position:new google.maps.LatLng(e.latitude,e.longitude),map:this.map,draggable:!0});this.infoWindow.setContent(this.infoWindowContent),this.marker.addListener("click",()=>{this.infoWindow.open(this.map,t)}),google.maps.event.addListener(t,"dragend",()=>{this.setLatLngFields(t.getPosition().lat().toFixed(6),t.getPosition().lng().toFixed(6),0)}),google.maps.event.addListener(this.map,"click",e=>{t.setPosition(e.latLng),this.setLatLngFields(e.latLng.lat().toFixed(6),e.latLng.lng().toFixed(6),0)}),this.marker=t};createArea=t=>{var o=[];if(t.configuration_map)for(let e=0;e<t.configuration_map.length;e++)o.push(new google.maps.LatLng(t.configuration_map[e].latitude,t.configuration_map[e].longitude));0===o.length&&o.push(new google.maps.LatLng(t.latitude,t.longitude));let i=new google.maps.Polygon(this.createPolygonOptions(o,this.extConf));var e=i.getPath();i.setMap(this.map),google.maps.event.addListener(e,"set_at",()=>{this.storeRouteAsJson(i)}),google.maps.event.addListener(e,"insert_at",()=>{this.storeRouteAsJson(i)}),google.maps.event.addListener(i,"rightclick",e=>{i.getPath().removeAt(e.vertex),this.storeRouteAsJson(i)}),google.maps.event.addListener(this.map,"click",e=>{i.getPath().push(e.latLng)}),google.maps.event.addListener(this.map,"dragend",()=>{this.setLatLngFields(this.map.getCenter().lat().toFixed(6),this.map.getCenter().lng().toFixed(6),0)})};createRoute=t=>{var o=[];if(t.configuration_map)for(let e=0;e<t.configuration_map.length;e++)o.push(new google.maps.LatLng(t.configuration_map[e].latitude,t.configuration_map[e].longitude));0===o.length&&o.push(new google.maps.LatLng(t.latitude,t.longitude));let i=new google.maps.Polyline(this.createPolylineOptions(o,this.extConf));var e=i.getPath();i.setMap(this.map),google.maps.event.addListener(e,"set_at",()=>{this.storeRouteAsJson(i)}),google.maps.event.addListener(e,"insert_at",()=>{this.storeRouteAsJson(i)}),google.maps.event.addListener(i,"rightclick",e=>{i.getPath().removeAt(e.vertex),this.storeRouteAsJson(i)}),google.maps.event.addListener(this.map,"click",e=>{i.getPath().push(e.latLng)}),google.maps.event.addListener(this.map,"dragend",()=>{this.setLatLngFields(this.map.getCenter().lat().toFixed(6),this.map.getCenter().lng().toFixed(6),0)})};createRadius=e=>{let t=new google.maps.Circle(this.createCircleOptions(this.map,e,this.extConf));google.maps.event.addListener(t,"center_changed",()=>{this.setLatLngFields(t.getCenter().lat().toFixed(6),t.getCenter().lng().toFixed(6),t.getRadius())}),google.maps.event.addListener(t,"radius_changed",()=>{this.setLatLngFields(t.getCenter().lat().toFixed(6),t.getCenter().lng().toFixed(6),t.getRadius())}),google.maps.event.addListener(this.map,"click",e=>{t.setCenter(e.latLng),this.setLatLngFields(e.latLng.lat().toFixed(6),e.latLng.lng().toFixed(6),this.marker.getRadius())}),this.setLatLngFields(e.latitude,e.longitude,e.radius),this.marker=t};setLatLngFields=(e,t,o,i)=>{this.setFieldValue("latitude",e),this.setFieldValue("longitude",t),void 0!==o&&0<o&&this.setFieldValue("radius",parseInt(o)),void 0!==i&&this.setFieldValue("address",i)};getUriForRoute=e=>{let o={};return e.getPath().forEach((e,t)=>{o[t]=e.toUrlValue()}),o};getFieldElement=e=>TYPO3.FormEngine.getFieldElement(this.buildFieldName(e),"_list");buildFieldName=e=>"data[tx_maps2_domain_model_poicollection]["+this.record.uid+"]["+e+"]";setFieldValue=(e,t)=>{var e=this.getFieldElement(e);e&&e.length&&((e=e.get(0)).value=t,e.dispatchEvent(new Event("change")))};storeRouteAsJson=e=>{this.setFieldValue("configuration_map",JSON.stringify(this.getUriForRoute(e)))};findAddress=()=>{var e=document.querySelector("#pac-input");let t=new google.maps.places.Autocomplete(e,{fields:["place_id"]}),o=new google.maps.Geocoder;t.bindTo("bounds",this.map),this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),e.addEventListener("keydown",e=>{var t=document.querySelector(".pac-container");if(13===e.keyCode&&null!==t)return!1}),t.addListener("place_changed",()=>{this.infoWindow.close();let a=t.getPlace();a.place_id&&o.geocode({placeId:a.place_id},(e,t)=>{if("OK"!==t)window.alert("Geocoder failed due to: "+t);else{var o=e[0].geometry.location.lat().toFixed(6),i=e[0].geometry.location.lng().toFixed(6);switch(this.record.collectionType){case"Point":this.marker.setPosition(e[0].geometry.location),this.marker.setVisible(!0),this.setLatLngFields(o,i,0,e[0].formatted_address);break;case"Area":case"Route":this.setLatLngFields(o,i,0,e[0].formatted_address);break;case"Radius":this.marker.setCenter(e[0].geometry.location),this.setLatLngFields(o,i,this.marker.getRadius(),e[0].formatted_address)}this.map.setCenter(e[0].geometry.location),this.infoWindowContent.children["place-name"].textContent=a.name,this.infoWindowContent.children["place-id"].textContent=a.place_id,this.infoWindowContent.children["place-address"].textContent=e[0].formatted_address,this.infoWindow.open(this.map,this.marker)}})})}}export default new GoogleMapsModule;
//# sourceMappingURL=GoogleMapsModule.min.js.map
