import{ExtConf,PoiCollection}from"@jweiland/maps2/Classes.js";import FormEngine from"@typo3/backend/form-engine.js";import Notification from"@typo3/backend/notification.js";class GoogleMapsModule{selector="#maps2ConfigurationMap";record=[];extConf=[];marker={};map={};infoWindow={};infoWindowContent={};constructor(){let e=document.querySelector(this.selector),t=new PoiCollection(JSON.parse(e.dataset.poiCollection)),i=new ExtConf(JSON.parse(e.dataset.extConf));this.load(i).then(()=>{this.initialize(e,t,i)})}load=t=>{return window._GoogleMapsModule=this,window._GoogleMapsModule.initMaps=this.initMaps.bind(this),new Promise(e=>{this.resolve=e;e=document.createElement("script");e.src=t.googleMapsLibrary+"&callback=_GoogleMapsModule.initMaps",e.async=!0,document.body.append(e)})};initMaps=()=>{this.resolve&&this.resolve()};initialize=(e,t,i)=>{switch(this.record=t,this.extConf=i,this.infoWindow=new google.maps.InfoWindow,this.infoWindowContent=document.getElementById("infowindow-content"),this.map=this.createMap(e),""===i.googleMapsJavaScriptApiKey&&Notification.warning("Missing JS API Key","You have forgotten to set Google Maps JavaScript ApiKey in Extension Settings.",15),""===i.googleMapsGeocodeApiKey&&Notification.warning("Missing GeoCode API Key","You have forgotten to set Google Maps Geocode ApiKey in Extension Settings.",15),t.collectionType){case"Point":this.createMarker(t);break;case"Area":this.createArea(t);break;case"Route":this.createRoute(t);break;case"Radius":this.createRadius(t)}this.findAddress(),t.latitude&&t.longitude?this.map.setCenter(new google.maps.LatLng(t.latitude,t.longitude)):this.map.setCenter(new google.maps.LatLng(i.defaultLatitude,i.defaultLongitude)),document.querySelector("ul.t3js-tabs li:nth-of-type(2) button[data-bs-toggle='tab']").addEventListener("shown.bs.tab",()=>{google.maps.event.trigger(this.map,"resize"),t.latitude&&t.longitude?this.map.setCenter(new google.maps.LatLng(t.latitude,t.longitude)):this.map.setCenter(new google.maps.LatLng(i.defaultLatitude,i.defaultLongitude))})};createMapOptions=function(){return{zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP}};createCircleOptions=function(e,t,i){e={map:e,center:new google.maps.LatLng(t.latitude,t.longitude),strokeColor:i.strokeColor,strokeOpacity:i.strokeOpacity,strokeWeight:i.strokeWeight,fillColor:i.fillColor,fillOpacity:i.fillOpacity,editable:!0};return 0===t.radius?e.radius=i.defaultRadius:e.radius=t.radius,e};createPolygonOptions=function(e,t){return{paths:e,strokeColor:t.strokeColor,strokeOpacity:t.strokeOpacity,strokeWeight:t.strokeWeight,fillColor:t.fillColor,fillOpacity:t.fillOpacity,editable:!0}};createPolylineOptions=function(e,t){return{path:e,strokeColor:t.strokeColor,strokeOpacity:t.strokeOpacity,strokeWeight:t.strokeWeight,editable:!0}};createMap=function(e){return new google.maps.Map(e,this.createMapOptions())};createMarker=function(e){this.marker=new google.maps.Marker({position:new google.maps.LatLng(e.latitude,e.longitude),map:this.map,draggable:!0}),this.infoWindow.setContent(this.infoWindowContent),this.marker.addListener("click",function(){this.infoWindow.open(this.map,this.marker)}),google.maps.event.addListener(this.marker,"dragend",function(){this.setLatLngFields(this.marker.getPosition().lat().toFixed(6),this.marker.getPosition().lng().toFixed(6),0)}),google.maps.event.addListener(this.map,"click",function(e){this.marker.setPosition(e.latLng),this.setLatLngFields(e.latLng.lat().toFixed(6),e.latLng.lng().toFixed(6),0)})};createArea=function(t){var i=[];if(t.configuration_map)for(let e=0;e<t.configuration_map.length;e++)i.push(new google.maps.LatLng(t.configuration_map[e].latitude,t.configuration_map[e].longitude));0===i.length&&i.push(new google.maps.LatLng(t.latitude,t.longitude));let o=new google.maps.Polygon(this.createPolygonOptions(i,this.extConf));var e=o.getPath();o.setMap(this.map),google.maps.event.addListener(e,"set_at",function(){this.storeRouteAsJson(o)}),google.maps.event.addListener(e,"insert_at",function(){this.storeRouteAsJson(o)}),google.maps.event.addListener(o,"rightclick",function(e){o.getPath().removeAt(e.vertex),this.storeRouteAsJson(o)}),google.maps.event.addListener(this.map,"click",function(e){o.getPath().push(e.latLng)}),google.maps.event.addListener(this.map,"dragend",function(){this.setLatLngFields(this.map.getCenter().lat().toFixed(6),this.map.getCenter().lng().toFixed(6),0)})};createRoute=function(t){var i=[];if(t.configuration_map)for(let e=0;e<t.configuration_map.length;e++)i.push(new google.maps.LatLng(t.configuration_map[e].latitude,t.configuration_map[e].longitude));0===i.length&&i.push(new google.maps.LatLng(t.latitude,t.longitude));let o=new google.maps.Polyline(this.createPolylineOptions(i,this.extConf));var e=o.getPath();o.setMap(this.map),google.maps.event.addListener(e,"set_at",function(){this.storeRouteAsJson(o)}),google.maps.event.addListener(e,"insert_at",function(){this.storeRouteAsJson(o)}),google.maps.event.addListener(o,"rightclick",function(e){o.getPath().removeAt(e.vertex),this.storeRouteAsJson(o)}),google.maps.event.addListener(this.map,"click",function(e){o.getPath().push(e.latLng)}),google.maps.event.addListener(this.map,"dragend",function(){this.setLatLngFields(this.map.getCenter().lat().toFixed(6),this.map.getCenter().lng().toFixed(6),0)})};createRadius=function(e){this.marker=new google.maps.Circle(this.createCircleOptions(this.map,e,this.extConf)),google.maps.event.addListener(this.marker,"center_changed",function(){this.setLatLngFields(this.marker.getCenter().lat().toFixed(6),this.marker.getCenter().lng().toFixed(6),this.marker.getRadius())}),google.maps.event.addListener(this.marker,"radius_changed",function(){this.setLatLngFields(this.marker.getCenter().lat().toFixed(6),this.marker.getCenter().lng().toFixed(6),this.marker.getRadius())}),google.maps.event.addListener(this.map,"click",function(e){this.marker.setCenter(e.latLng),this.setLatLngFields(e.latLng.lat().toFixed(6),e.latLng.lng().toFixed(6),this.marker.getRadius())}),this.setLatLngFields(e.latitude,e.longitude,e.radius)};setLatLngFields=(e,t,i,o)=>{this.setFieldValue("latitude",e),this.setFieldValue("longitude",t),void 0!==i&&0<i&&this.setFieldValue("radius",parseInt(i)),void 0!==o&&this.setFieldValue("address",o)};getUriForRoute=e=>{let i={};return e.getPath().forEach((e,t)=>{i[t]=e.toUrlValue()}),i};getFieldElement=e=>TYPO3.FormEngine.getFieldElement(this.buildFieldName(e),"_list");buildFieldName=e=>"data[tx_maps2_domain_model_poicollection]["+this.record.uid+"]["+e+"]";setFieldValue=(e,t)=>{var e=this.getFieldElement(e);e&&e.length&&((e=e.get(0)).value=t,e.dispatchEvent(new Event("change")))};storeRouteAsJson=e=>{this.setFieldValue("configuration_map",JSON.stringify(this.getUriForRoute(e)))};findAddress=()=>{var e=document.querySelector("#pac-input");let t=new google.maps.places.Autocomplete(e,{fields:["place_id"]}),i=new google.maps.Geocoder;t.bindTo("bounds",this.map),this.map.controls[google.maps.ControlPosition.TOP_LEFT].push(e),e.addEventListener("keydown",e=>{var t=document.querySelector(".pac-container");if(13===e.keyCode&&null!==t)return!1}),t.addListener("place_changed",()=>{this.infoWindow.close();let n=t.getPlace();n.place_id&&i.geocode({placeId:n.place_id},(e,t)=>{if("OK"!==t)window.alert("Geocoder failed due to: "+t);else{var i=e[0].geometry.location.lat().toFixed(6),o=e[0].geometry.location.lng().toFixed(6);switch(this.record.collectionType){case"Point":this.marker.setPosition(e[0].geometry.location),this.marker.setVisible(!0),this.setLatLngFields(i,o,0,e[0].formatted_address);break;case"Area":case"Route":this.setLatLngFields(i,o,0,e[0].formatted_address);break;case"Radius":this.marker.setCenter(e[0].geometry.location),this.setLatLngFields(i,o,this.marker.getRadius(),e[0].formatted_address)}this.map.setCenter(e[0].geometry.location),this.infoWindowContent.children["place-name"].textContent=n.name,this.infoWindowContent.children["place-id"].textContent=n.place_id,this.infoWindowContent.children["place-address"].textContent=e[0].formatted_address,this.infoWindow.open(this.map,this.marker)}})})}}export default new GoogleMapsModule;
//# sourceMappingURL=GoogleMapsModule.min.js.map
